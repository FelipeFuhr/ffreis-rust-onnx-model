name: Container Vulnerability Scan (Trivy)
on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
    paths:
      - "app/**"
      - "container/**"
      - ".trivyignore.yaml"
      - "Makefile"
      - ".github/workflows/trivy.yml"
  push:
    branches: [ main ]
    paths:
      - "app/**"
      - "container/**"
      - ".trivyignore.yaml"
      - "Makefile"
      - ".github/workflows/trivy.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  image-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install Podman
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y podman
      - name: Build images
        run: |
          set -euo pipefail
          CONTAINER_COMMAND=podman make build
      - name: Install Trivy
        run: |
          set -euo pipefail
          TRIVY_INSTALL_REF="v0.67.2"
          curl -sfL \
            --proto '=https' \
            --proto-redir '=https' \
            "https://raw.githubusercontent.com/aquasecurity/trivy/${TRIVY_INSTALL_REF}/contrib/install.sh" \
            | sudo sh -s -- -b /usr/local/bin
          trivy --version
      - name: Save images and scan (parallel, Podman)
        run: |
          set -euo pipefail
          mkdir -p artifacts trivy-results
          images=(ffreis/base ffreis/base-builder ffreis/builder ffreis/base-runner ffreis/runner)

          # Warm DB once to avoid duplicate updates and lock contention in parallel scans.
          trivy image --download-db-only --no-progress

          scan_image() {
            image="$1"
            name="${image##*/}"
            tar="artifacts/${name}.tar"

            podman save -o "$tar" "$image"
            test -s "$tar"
            # 1) Always produce SARIF for all severities so GitHub code scanning
            # has complete visibility, regardless of pass/fail gate outcome.
            trivy image \
              --input "$tar" \
              --skip-db-update \
              --no-progress \
              --ignorefile .trivyignore.yaml \
              --scanners vuln \
              --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
              --ignore-unfixed \
              --exit-code 0 \
              --format sarif \
              --output "trivy-results/${name}.sarif"
            test -s "trivy-results/${name}.sarif"

            # 1b) Export JSON for trend analysis and triage automation.
            trivy image \
              --input "$tar" \
              --skip-db-update \
              --no-progress \
              --ignorefile .trivyignore.yaml \
              --scanners vuln \
              --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
              --ignore-unfixed \
              --exit-code 0 \
              --format json \
              --output "trivy-results/${name}.json"
            test -s "trivy-results/${name}.json"

            # 2) Print a human-readable full report in CI logs (all severities).
            echo "Full vulnerability report for ${image} (all severities):"
            trivy image \
              --input "$tar" \
              --skip-db-update \
              --no-progress \
              --ignorefile .trivyignore.yaml \
              --scanners vuln \
              --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
              --ignore-unfixed \
              --exit-code 0 \
              --format table

            # 3) Check for HIGH/CRITICAL vulnerabilities but capture exit status
            # instead of failing immediately so reports can be uploaded.
            # Note: not using --ignore-unfixed here to ensure all HIGH/CRITICAL findings
            # (fixed or unfixed) are gated. Use .trivyignore.yaml for explicit suppressions.
            echo "Gating ${image} on HIGH/CRITICAL vulnerabilities..."
            if ! trivy image \
              --input "$tar" \
              --skip-db-update \
              --no-progress \
              --ignorefile .trivyignore.yaml \
              --scanners vuln \
              --severity HIGH,CRITICAL \
              --exit-code 1 \
              --format table; then
              echo "FAIL" > "trivy-results/${name}.gate-status"
            else
              echo "PASS" > "trivy-results/${name}.gate-status"
            fi
          }

          pids=()
          for image in "${images[@]}"; do
            scan_image "$image" &
            pids+=("$!")
          done

          for pid in "${pids[@]}"; do
            wait "$pid"
          done
      - name: Upload Trivy JSON reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-json-reports
          path: trivy-results/*.json
          if-no-files-found: error
      - name: Upload Trivy SARIF (per image)
        if: always() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false)
        shell: bash
        run: |
          set -euo pipefail
          for f in trivy-results/*.sarif; do
            name="$(basename "$f" .sarif)"
            echo "Uploading $f with tool_name trivy-$name"
            sarif_payload="$(gzip -c "$f" | base64 | tr -d '\n')"
            gh api \
              -X POST \
              /repos/${{ github.repository }}/code-scanning/sarifs \
              -f sarif="${sarif_payload}" \
              -f tool_name="trivy-${name}" \
              -f commit_sha="${{ github.sha }}" \
              -f ref="${{ github.ref }}"
          done
        env:
          GH_TOKEN: ${{ github.token }}
      - name: Check gate results
        if: always()
        run: |
          set -euo pipefail
          shopt -s nullglob
          failed=0
          gate_files=(trivy-results/*.gate-status)
          if [ ${#gate_files[@]} -eq 0 ]; then
            echo "::error::No gate status files found - scans may not have completed"
            exit 1
          fi
          for f in "${gate_files[@]}"; do
            name="$(basename "$f" .gate-status)"
            status="$(cat "$f")"
            if [ "$status" = "FAIL" ]; then
              echo "::error::Image ${name} failed HIGH/CRITICAL vulnerability gate"
              failed=1
            elif [ "$status" = "PASS" ]; then
              echo "Image ${name} passed HIGH/CRITICAL vulnerability gate"
            else
              echo "::error::Image ${name} has unexpected gate status: ${status}"
              failed=1
            fi
          done
          exit $failed
