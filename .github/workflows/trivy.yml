name: Container Vulnerability Scan (Trivy)
on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  image-scan:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image:
          - ffreis/base
          - ffreis/base-builder
          - ffreis/builder
          - ffreis/base-runner
          - ffreis/runner
        tar:
          - base.tar
          - base-builder.tar
          - builder.tar
          - base-runner.tar
          - runner.tar
    steps:
      - uses: actions/checkout@v4
      - name: Install Podman
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y podman
      - name: Build images
        run: |
          set -euo pipefail
          CONTAINER_COMMAND=podman make build
      - name: Save image tar
        run: |
          set -euo pipefail
          mkdir -p artifacts
          podman save -o "artifacts/${{ matrix.tar }}" "${{ matrix.image }}"
          test -s "artifacts/${{ matrix.tar }}"
      - name: Scan with Trivy
        uses: aquasecurity/trivy-action@v1
        with:
          input: artifacts/${{ matrix.tar }}
          exit-code: '1'
